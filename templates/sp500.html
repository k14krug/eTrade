{% extends "base.html" %}

{% block title %}S&P 500 Data{% endblock %}

{% block content %}
<h1>S&P 500 Data</h1>

{% if task_id %}
<div id="progress_bar">
    <div class="progress-label">Updating data...</div>
    <progress id="progress" value="0" max="100"></progress>
</div>
{% else %}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Current Price</th>
                <th>Previous Price</th>
                <th>Gain/Loss</th>
                <th>Gain/Loss %</th>
                <th>Monthly High</th>
                <th>Monthly Low</th>
                <th>Up Days</th>
                <th>Down Days</th>
                <th>Current P/E</th>
                <th>1Y Target</th>
                <th>Earnings Date</th>
                <th>52W Low</th>
                <th>52W High</th>
            </tr>
        </thead>
        <tbody>
            {% for stock in data %}
            <tr>
                <td>{{ stock.symbol }}</td>
                <td>{{ stock.current_price }}</td>
                <td>{{ stock.previous_price }}</td>
                <td>{{ stock.gain_loss }}</td>
                <td>{{ stock.gain_loss_percentage }}%</td>
                <td>{{ stock.monthly_high }}</td>
                <td>{{ stock.monthly_low }}</td>
                <td>{{ stock.up_days }}</td>
                <td>{{ stock.down_days }}</td>
                <td>{{ stock.current_pe }}</td>
                <td>{{ stock.one_year_target }}</td>
                <td>{{ stock.earnings_date }}</td>
                <td>{{ stock.fifty_two_week_low }}</td>
                <td>{{ stock.fifty_two_week_high }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if total_pages > 1 %}
<nav aria-label="Page navigation">
    <ul class="pagination">
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('sp500', page=p, sort_by=sort_by, sort_order=sort_order) }}">{{ p }}</a>
        </li>
        {% endfor %}
    </ul>
</nav>
{% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
{% if task_id %}
var socket = io.connect('http://' + document.domain + ':' + location.port);

function update_progress(status_url) {
    $.getJSON(status_url, function(data) {
        console.log(data);
        $('#progress').attr('value', data['current'] * 100 / data['total']);
        $('.progress-label').text(data['status']);
        if (data['state'] != 'PENDING' && data['state'] != 'PROGRESS') {
            if ('result' in data) {
                location.reload();
            }
            else {
                $('.progress-label').text('Error: ' + data['status']);
            }
        }
        else {
            setTimeout(function() {
                update_progress(status_url);
            }, 2000);
        }
    });
}
$(function() {
    update_progress('{{ url_for("task_status", task_id=task_id) }}');
});
{% endif %}
</script>
{% endblock %}