{% extends "base.html" %}

{% block title %}S&P 500 Overview{% endblock %}

{% block content %}
<h1>S&P 500 Overview</h1>

<button id="update-data" class="btn btn-primary mb-3">Update Today's Data</button>
<div id="update-status"></div>

<button id="update-hist-data" class="btn btn-primary mb-3">Update Hist Data</button>
<div id="update-status"></div>

<table id="sp500-table" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Symbol</th>
            <th>Company Name</th>
            <th>Latest Price</th>
            <th>Previous Day Price</th>
            <th>Gain/Loss %</th>
            <th>Month High</th>
            <th>Month Low</th>
            <th>P/E Ratio</th>
            <th>1 Year Target</th>
            <th>52 Week Range</th>
            <th>Times Above 1%</th>
            <th>Times Below 1%</th>
            <th>Last Update</th>
        </tr>
    </thead>
    <tbody>
        {% for stock in stocks %}
        <tr>
            <td><a href="{{ url_for('sp500.stock_detail', symbol=stock.symbol) }}">{{ stock.symbol }}</a></td>
            <td>{{ stock.company_name }}</td>
            <td>{{ stock.info.latest_price }}</td>
            <td>{{ stock.info.previous_day_price }}</td>
            <td>
                {% if stock.info.latest_price is not none and stock.info.previous_day_price is not none %}
                    {{ ((stock.info.latest_price - stock.info.previous_day_price) / stock.info.previous_day_price * 100) | round(2) }}%
                {% else %}
                    N/A
                {% endif %}
            </td>
            <td>{{ stock.info.month_high }}</td>
            <td>{{ stock.info.month_low }}</td>
            <td>{{ stock.info.pe_ratio }}</td>
            <td>{{ stock.info.one_year_target }}</td>
            <td>{{ stock.info.fifty_two_week_low }} - {{ stock.info.fifty_two_week_high }}</td>
            <td>{{ stock.info.times_above_one_percent }}</td>
            <td>{{ stock.info.times_below_one_percent }}</td>
            <td>{{ stock.info.last_updated }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    $('#sp500-table').DataTable({
        "pageLength": 25,
        "order": [[4, "desc"]]  // Sort by Gain/Loss % column descending
    });

    $('#update-data').click(function() {
        $.ajax({
            url: '{{ url_for("main.update_data") }}',
            method: 'POST',
            success: function(response) {
                $('#update-status').text('Update task started. Task ID: ' + response.task_id);
                checkTaskStatus(response.task_id);
            },
            error: function() {
                $('#update-status').text('Error starting update task');
            }
        });
    });

    $('#update-hist-data').click(function() {
        $.ajax({
            url: '{{ url_for("sp500.update_hist_data") }}',
            method: 'POST',
            success: function(response) {
                $('#update-status').text('Update task started. Task ID: ' + response.task_id);
                checkTaskStatus(response.task_id);
            },
            error: function() {
                $('#update-status').text('Error starting update task');
            }
        });
    });
    function checkTaskStatus(taskId) {
        $.ajax({
            url: '{{ url_for("main.task_status", task_id="") }}' + taskId,
            method: 'GET',
            success: function(response) {
                $('#update-status').text('Task status: ' + response.status);
                if (response.state !== 'SUCCESS' && response.state !== 'FAILURE') {
                    setTimeout(function() {
                        checkTaskStatus(taskId);
                    }, 5000);  // Check again after 5 seconds
                } else if (response.state === 'SUCCESS') {
                    location.reload();  // Reload the page to show updated data
                }
            },
            error: function() {
                $('#update-status').text('Error checking task status');
            }
        });
    }
});
</script>
{% endblock %}