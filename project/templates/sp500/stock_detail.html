{% extends "base.html" %}

{% block content %}
<h1>{{ stock.symbol }} - {{ stock.company_name }}</h1>

<!-- Timeframe selection form -->
<form method="GET" action="{{ url_for('sp500.stock_detail', symbol=stock.symbol) }}" id="timeframe-form">
    <label for="timeframe">Select Timeframe:</label>
    <select name="timeframe" id="timeframe">
        <option value="max" {% if timeframe == 'max' %}selected{% endif %}>Max</option>
        <option value="1y" {% if timeframe == '1y' %}selected{% endif %}>1 Year</option>
        <option value="ytd" {% if timeframe == 'ytd' %}selected{% endif %}>Year to Date (YTD)</option>
        <option value="3m" {% if timeframe == '3m' %}selected{% endif %}>3 Months</option>
        <option value="1m" {% if timeframe == '1m' %}selected{% endif %}>1 Month</option>
        <option value="5d" {% if timeframe == '5d' %}selected{% endif %}>Last 5 Days</option>
        <option value="intraday" {% if timeframe == 'intraday' %}selected{% endif %}>Intraday</option>

    </select>
</form>

<h2>Current Information</h2>
<table>
    <!-- Displaying current stock information -->
    <tr><th>Latest Price</th><td>{{ stock.info.latest_price }}</td></tr>
    <tr><th>Previous Day Price</th><td>{{ stock.info.previous_day_price }}</td></tr>
    <tr><th>P/E Ratio</th><td>{{ stock.info.pe_ratio }}</td></tr>
    <tr><th>1 Year Target</th><td>{{ stock.info.one_year_target }}</td></tr>
    <tr><th>52 Week Range</th><td>{{ stock.info.fifty_two_week_low }} - {{ stock.info.fifty_two_week_high }}</td></tr>
    <tr><th>Month High</th><td>{{ stock.info.month_high }}</td></tr>
    <tr><th>Month Low</th><td>{{ stock.info.month_low }}</td></tr>
    <tr><th>Times Above 1% in Past Month</th><td>{{ stock.info.times_above_one_percent }}</td></tr>
    <tr><th>Times Below 1% in Past Month</th><td>{{ stock.info.times_below_one_percent }}</td></tr>
</table>

<h2>Historical Price Chart</h2>
<div id="price-chart"></div>

<h2>Historical Volume Chart</h2>
<div id="volume-chart"></div>

{% endblock %}

{% block scripts %}

<script>
    // Add event listener to the dropdown to auto-submit the form when a new option is selected
    document.getElementById('timeframe').addEventListener('change', function() {
        document.getElementById('timeframe-form').submit();  // Ensure this targets the correct form ID
    });
</script>

<!-- Load Plotly from CDN -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the selected timeframe from the URL query parameters
        const params = new URLSearchParams(window.location.search);
        const timeframe = params.get('timeframe') || '1y';  // Default to '1y' if not specified
    
        // Fetch historical or intraday data with the selected timeframe in JSON format
        fetch(`{{ url_for("sp500.stock_detail", symbol=stock.symbol) }}?timeframe=${timeframe}&format=json`)
            .then(response => response.json())
            .then(data => {
                // Create price chart
                var priceTrace = {
                    x: data.dates,
                    y: data.prices,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Price'
                };
    
                var priceLayout = {
                    title: '{{ stock.symbol }} Price Chart',
                    xaxis: { title: 'Date/Time' },
                    yaxis: { title: 'Price' }
                };
    
                Plotly.newPlot('price-chart', [priceTrace], priceLayout);
    
                // Create volume chart
                var volumeTrace = {
                    x: data.dates,
                    y: data.volumes,
                    type: 'bar',
                    name: 'Volume'
                };
    
                var volumeLayout = {
                    title: '{{ stock.symbol }} Volume Chart',
                    xaxis: { title: 'Date/Time' },
                    yaxis: { title: 'Volume' }
                };
    
                Plotly.newPlot('volume-chart', [volumeTrace], volumeLayout);
            })
            .catch(error => console.error('Error fetching data:', error));
    });
    
</script>
{% endblock %}
